<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Motion Picture Club, IIM Kashipur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d0d;
            color: #f5f5f5;
            cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolygon points='12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2'/%3E%3C/svg%3E") 12 12, auto;
        }
        
        .custom-cursor {
            pointer-events: none;
            position: absolute;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.1s ease-out;
            width: 50px;
            height: 50px;
            z-index: 9999;
        }

        .custom-cursor.active {
            opacity: 1;
        }

        .movie-card {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .movie-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        .movie-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .movie-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
            color: white;
            padding: 1rem;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        
        .movie-card:hover .movie-info {
            transform: translateY(0);
        }

        .btn {
            @apply px-4 py-2 rounded-lg font-semibold transition-colors duration-200;
        }

        .btn-blue {
            @apply bg-blue-600 hover:bg-blue-700 text-white;
        }

        .btn-green {
            @apply bg-green-600 hover:bg-green-700 text-white;
        }
    </style>
</head>
<body class="min-h-screen p-8">

    <!-- Custom Cursor Element -->
    <div id="custom-cursor" class="custom-cursor"></div>

    <main class="container mx-auto px-4 md:px-8 py-12">
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-6xl font-extrabold text-white mb-2">The Motion Picture Club, IIM Kashipur</h1>
            <p class="text-lg md:text-xl text-gray-400">Discover and discuss your favorite films.</p>
        </header>

        <!-- Search Bar -->
        <div class="mb-8 p-4 bg-gray-800 rounded-lg shadow-inner">
            <input type="text" id="search-input" placeholder="Search for a movie..." class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
        </div>
        
        <!-- Public Movie Database from Google Sheets -->
        <section id="google-sheet-section">
            <h2 class="text-2xl md:text-3xl font-bold text-white mb-6">Explore Movies</h2>
            <div id="google-sheet-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 md:gap-6">
                <div id="loading" class="text-white text-center text-lg col-span-full">
                    <p>Loading movies from Google Sheet...</p>
                </div>
                <!-- Movies from Google Sheet will be dynamically added here -->
            </div>
        </section>

        <!-- Watchlist Section -->
        <section class="mt-12">
            <h2 class="text-2xl md:text-3xl font-bold text-white mb-6">Your Watchlist</h2>
            <div id="watchlist-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 md:gap-6">
                <!-- Watchlist movies will be dynamically added here -->
            </div>
        </section>
    </main>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Variables ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let allMovies = [];

        // --- Constants ---
        // IMPORTANT: Replace this URL with the published CSV URL of your Google Sheet
        const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZs7j4FbPrLuZfFIJ3_GU81sxg88M_1Dgeknw3-atgGCUUtpA6918M6whTq3INJolANybqi1U2NfO9/pub?gid=0&single=true&output=csv";
        
        // --- DOM Elements ---
        const googleSheetContainer = document.getElementById('google-sheet-container');
        const watchlistContainer = document.getElementById('watchlist-container');
        const searchInput = document.getElementById('search-input');
        const customCursor = document.getElementById('custom-cursor');

        // --- Firebase Initialization and Authentication ---
        let db, auth, userId;
        
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        setupWatchlistListener();
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        };

        // --- Firestore Functions ---
        const getWatchlistCollectionRef = () => {
            const path = `/artifacts/${appId}/users/${userId}/watchlist`;
            return collection(db, path);
        };
        
        const addMovieToWatchlist = async (movie) => {
            try {
                const watchlistRef = getWatchlistCollectionRef();
                // Store the movie details, including the Drive_URL
                await addDoc(watchlistRef, movie);
                console.log("Movie added to watchlist!");
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        };
        
        const setupWatchlistListener = () => {
            const watchlistRef = getWatchlistCollectionRef();
            onSnapshot(watchlistRef, (snapshot) => {
                const movies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMovies(movies, watchlistContainer, false);
            });
        };

        // --- Google Sheets Data Fetching ---
        const fetchMoviesFromGoogleSheet = async () => {
            if (GOOGLE_SHEET_URL === "YOUR_GOOGLE_SHEET_URL_HERE") {
                document.getElementById('loading').textContent = "Please set the Google Sheet URL in the code.";
                return;
            }

            try {
                const response = await fetch(GOOGLE_SHEET_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                allMovies = parseCSV(csvText);
                document.getElementById('loading').remove();
                renderMovies(allMovies, googleSheetContainer, true);
            } catch (error) {
                console.error("Error fetching movies from Google Sheet:", error);
                document.getElementById('loading').textContent = "Failed to load movies. Check the URL.";
            }
        };

        const parseCSV = (text) => {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                let movie = {};
                headers.forEach((header, i) => {
                    movie[header] = values[i];
                });
                return movie;
            });
            return data;
        };
        
        // --- UI Rendering Functions ---
        const renderMovies = (movies, container, showAddButton) => {
            container.innerHTML = '';
            
            if (movies.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-400">No movies found.</p>`;
                return;
            }

            movies.forEach(movie => {
                const movieCard = document.createElement('div');
                movieCard.classList.add('movie-card');
                
                const posterPath = movie.Poster_URL || 'https://placehold.co/400x600/1e293b/d1d5db?text=No+Image';
                const releaseYear = movie.Release_Date || 'N/A';
                
                movieCard.innerHTML = `
                    <img src="${posterPath}" alt="${movie.Title} Poster">
                    <div class="movie-info p-4">
                        <h3 class="text-lg font-semibold truncate">${movie.Title}</h3>
                        <p class="text-sm text-gray-400 mb-2">${releaseYear}</p>
                        ${showAddButton ? `
                            <div class="flex space-x-2">
                                <button class="add-btn btn btn-blue flex-1">Add to Watchlist</button>
                                ${movie.Drive_URL ? `<a href="${movie.Drive_URL}" target="_blank" class="btn btn-green block text-center flex-1">Watch Now</a>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                if (showAddButton) {
                    const addButton = movieCard.querySelector('.add-btn');
                    addButton.addEventListener('click', () => {
                        addMovieToWatchlist({
                            title: movie.Title || null,
                            release_date: movie.Release_Date || null,
                            poster_path: movie.Poster_URL || null,
                            drive_url: movie.Drive_URL || null
                        });
                    });
                }
                
                container.appendChild(movieCard);
            });
        };

        // --- Search Functionality ---
        const filterMovies = () => {
            const query = searchInput.value.toLowerCase();
            const filteredMovies = allMovies.filter(movie => {
                return movie.Title.toLowerCase().includes(query);
            });
            renderMovies(filteredMovies, googleSheetContainer, true);
        };
        
        // --- Event Listeners and Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            fetchMoviesFromGoogleSheet();
            
            // Search input listener
            searchInput.addEventListener('keyup', filterMovies);

            // Custom cursor logic
            document.addEventListener('mousemove', (e) => {
                customCursor.style.left = `${e.clientX}px`;
                customCursor.style.top = `${e.clientY}px`;
                if (!customCursor.classList.contains('active')) {
                    customCursor.classList.add('active');
                }
            });
            document.addEventListener('mouseleave', () => {
                customCursor.classList.remove('active');
            });
        });
    </script>
</body>
</html>
