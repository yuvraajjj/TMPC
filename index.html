<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Motion Picture Club</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d0d;
            color: #f5f5f5;
            cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolygon points='12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2'/%3E%3C/svg%3E") 12 12, auto;
        }
        
        .custom-cursor {
            pointer-events: none;
            position: absolute;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.1s ease-out;
            width: 50px;
            height: 50px;
            z-index: 9999;
        }
        
        .custom-cursor.active {
            opacity: 1;
        }

        .movie-card {
            position: relative;
            flex-shrink: 0;
            width: 180px;
            height: 270px;
            overflow: hidden;
            border-radius: 8px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .movie-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        .movie-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .movie-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
            color: white;
            padding: 1rem;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        
        .movie-card:hover .movie-info {
            transform: translateY(0);
        }

        .btn {
            @apply px-4 py-2 rounded-lg font-semibold transition-colors duration-200;
        }

        .btn-blue {
            @apply bg-blue-600 hover:bg-blue-700 text-white;
        }

        .btn-green {
            @apply bg-green-600 hover:bg-green-700 text-white;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="min-h-screen bg-[#0d0d0d] text-[#f5f5f5]">

    <!-- Custom Cursor Element -->
    <div id="custom-cursor" class="custom-cursor"></div>

    <header class="pt-12 pb-6 px-4 md:px-8 text-center bg-gray-900 shadow-lg">
        <div class="flex justify-center items-center space-x-4 mb-4">
            <img src="https://www.iimkashipur.ac.in/page/image/1678950321.jpg" alt="IIM Kashipur Logo" class="w-16 h-16 md:w-20 md:h-20 rounded-full">
            <img src="https://www.iimkashipur.ac.in/uploads/club/175051600324.png" alt="TMPC Logo" class="w-16 h-16 md:w-20 md:h-20 rounded-full">
        </div>
        <h1 class="text-4xl md:text-6xl font-extrabold text-white mb-2 drop-shadow-md">The Motion Picture Club</h1>
        <h2 class="text-lg md:text-xl text-gray-300 font-medium drop-shadow-sm">IIM Kashipur</h2>
        <p class="text-sm md:text-md italic text-gray-400 mt-1 drop-shadow-sm">In service of the cinema</p>
    </header>
    
    <main class="container mx-auto px-4 md:px-8 py-12">
        <!-- Navigation Tabs -->
        <nav class="flex justify-center mb-8 p-1 bg-gray-800 rounded-full shadow-inner">
            <button id="tab-movies" class="px-6 py-2 rounded-full font-bold bg-blue-600 text-white transition-colors duration-200">Movies</button>
            <button id="tab-series" class="px-6 py-2 rounded-full font-bold text-gray-300 hover:bg-gray-700 transition-colors duration-200">Series</button>
            <button id="tab-anime" class="px-6 py-2 rounded-full font-bold text-gray-300 hover:bg-gray-700 transition-colors duration-200">Anime</button>
        </nav>

        <!-- Search Bar -->
        <div class="mb-8 p-4 bg-gray-800 rounded-lg shadow-inner">
            <input type="text" id="search-input" placeholder="Search for a title..." class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
        </div>

        <!-- Content Sections -->
        <section id="section-movies">
            <div id="movies-container" class="space-y-8">
                <div id="loading-movies" class="text-white text-center text-lg col-span-full">
                    <p>Loading movies from Google Sheet...</p>
                </div>
            </div>
        </section>

        <section id="section-series" class="hidden">
            <div id="series-container" class="space-y-8">
                <div id="loading-series" class="text-white text-center text-lg col-span-full">
                    <p>Loading series from Google Sheet...</p>
                </div>
            </div>
        </section>

        <section id="section-anime" class="hidden">
            <div id="anime-container" class="space-y-8">
                <div id="loading-anime" class="text-white text-center text-lg col-span-full">
                    <p>Loading anime from Google Sheet...</p>
                </div>
            </div>
        </section>
        
        <!-- Watchlist Section -->
        <section class="mt-12">
            <h2 class="text-2xl md:text-3xl font-bold text-white mb-6">Your Watchlist</h2>
            <div id="watchlist-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 md:gap-6">
                <!-- Watchlist movies will be dynamically added here -->
            </div>
        </section>
    </main>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Variables ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let allContent = [];
        let activeTab = 'movies';

        // --- Constants ---
        const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZs7j4FbPrLuZfFIJ3_GU81sxg88M_1Dgeknw3-atgGCUUtpA6918M6whTq3INJolANybqi1U2NfO9/pub?gid=0&single=true&output=csv";
        
        // --- DOM Elements ---
        const moviesContainer = document.getElementById('movies-container');
        const seriesContainer = document.getElementById('series-container');
        const animeContainer = document.getElementById('anime-container');
        const watchlistContainer = document.getElementById('watchlist-container');
        const searchInput = document.getElementById('search-input');
        const customCursor = document.getElementById('custom-cursor');
        const moviesSection = document.getElementById('section-movies');
        const seriesSection = document.getElementById('section-series');
        const animeSection = document.getElementById('section-anime');
        const tabMovies = document.getElementById('tab-movies');
        const tabSeries = document.getElementById('tab-series');
        const tabAnime = document.getElementById('tab-anime');
        const loadingMovies = document.getElementById('loading-movies');
        const loadingSeries = document.getElementById('loading-series');
        const loadingAnime = document.getElementById('loading-anime');

        // --- Firebase Initialization and Authentication ---
        let db, auth, userId;
        
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        setupWatchlistListener();
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        };

        // --- Firestore Functions ---
        const getWatchlistCollectionRef = () => {
            const path = `/artifacts/${appId}/users/${userId}/watchlist`;
            return collection(db, path);
        };
        
        const addMovieToWatchlist = async (movie) => {
            try {
                const watchlistRef = getWatchlistCollectionRef();
                await addDoc(watchlistRef, movie);
                console.log("Movie added to watchlist!");
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        };
        
        const setupWatchlistListener = () => {
            const watchlistRef = getWatchlistCollectionRef();
            onSnapshot(watchlistRef, (snapshot) => {
                const movies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderWatchlistCards(movies, watchlistContainer);
            });
        };

        // --- Google Sheets Data Fetching ---
        const fetchContentFromGoogleSheet = async () => {
            if (GOOGLE_SHEET_URL === "YOUR_GOOGLE_SHEET_URL_HERE") {
                if (loadingMovies) loadingMovies.textContent = "Please set the Google Sheet URL in the code.";
                if (loadingSeries) loadingSeries.textContent = "Please set the Google Sheet URL in the code.";
                if (loadingAnime) loadingAnime.textContent = "Please set the Google Sheet URL in the code.";
                return;
            }

            try {
                const response = await fetch(GOOGLE_SHEET_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                allContent = parseCSV(csvText);
                
                if (loadingMovies) loadingMovies.remove();
                if (loadingSeries) loadingSeries.remove();
                if (loadingAnime) loadingAnime.remove();

                renderCategories(allContent);
            } catch (error) {
                console.error("Error fetching content from Google Sheet:", error);
                if (loadingMovies) loadingMovies.textContent = "Failed to load content. Check the URL.";
                if (loadingSeries) loadingSeries.textContent = "Failed to load content. Check the URL.";
                if (loadingAnime) loadingAnime.textContent = "Failed to load content. Check the URL.";
            }
        };

        const parseCSV = (text) => {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                let content = {};
                headers.forEach((header, i) => {
                    content[header] = values[i];
                });
                return content;
            });
            return data;
        };

        const renderCategories = (content) => {
            const movies = content.filter(item => item.Type && item.Type.toLowerCase() === 'movie');
            const series = content.filter(item => item.Type && item.Type.toLowerCase() === 'series');
            const anime = content.filter(item => item.Type && item.Type.toLowerCase() === 'anime');
            
            renderGenreRows(movies, moviesContainer, 'movie');
            renderGenreRows(series, seriesContainer, 'series');
            renderGenreRows(anime, animeContainer, 'anime');
        };

        const renderGenreRows = (content, container, type) => {
            container.innerHTML = '';
            
            if (content.length === 0) {
                const message = `<p class="text-center text-gray-400 col-span-full">No ${type} found.</p>`;
                container.innerHTML = message;
                return;
            }

            const topPicks = content.filter(item => item.Top_Pick && item.Top_Pick.toLowerCase() === 'yes');
            const otherGenres = content.filter(item => item.Genre && item.Genre !== 'undefined' && item.Genre.trim() !== '' && (item.Top_Pick === undefined || item.Top_Pick.toLowerCase() !== 'yes'));

            if (topPicks.length > 0) {
                const topPicksContainer = createGenreSection("TMPC Top Picks of the Month", topPicks);
                container.appendChild(topPicksContainer);
            }

            const uniqueGenres = [...new Set(otherGenres.map(item => item.Genre))];
            
            uniqueGenres.forEach(genre => {
                const genreContent = otherGenres.filter(item => item.Genre === genre);
                const genreContainer = createGenreSection(genre, genreContent);
                container.appendChild(genreContainer);
            });
        };
        
        const createGenreSection = (title, content) => {
            const section = document.createElement('div');
            section.classList.add('genre-section');
            
            const sectionTitle = document.createElement('h2');
            sectionTitle.classList.add('text-xl', 'md:text-2xl', 'font-bold', 'text-white', 'mb-4', 'mt-8');
            sectionTitle.textContent = title;
            
            const cardsContainer = document.createElement('div');
            cardsContainer.classList.add('flex', 'space-x-4', 'overflow-x-scroll', 'py-4', 'scrollbar-hide');
            
            content.forEach(item => {
                const card = createCard(item, true);
                cardsContainer.appendChild(card);
            });
            
            section.appendChild(sectionTitle);
            section.appendChild(cardsContainer);
            return section;
        };

        const createCard = (item, showAddButton) => {
            const card = document.createElement('div');
            card.classList.add('movie-card');
            
            const posterPath = item.Poster_URL || 'https://placehold.co/400x600/1e293b/d1d5db?text=No+Image';
            const releaseYear = item.Release_Date || 'N/A';

            card.innerHTML = `
                <img src="${posterPath}" alt="${item.Title} Poster">
                <div class="movie-info p-4">
                    <h3 class="text-lg font-semibold truncate">${item.Title}</h3>
                    <p class="text-sm text-gray-400 mb-2">${releaseYear}</p>
                    ${showAddButton ? `
                        <div class="flex space-x-2">
                            <button class="add-btn btn btn-blue flex-1">Add</button>
                            ${item.Drive_URL ? `<a href="${item.Drive_URL}" target="_blank" class="btn btn-green block text-center flex-1">Watch</a>` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
            
            if (showAddButton) {
                const addButton = card.querySelector('.add-btn');
                addButton.addEventListener('click', () => {
                    addMovieToWatchlist({
                        title: item.Title || null,
                        release_date: item.Release_Date || null,
                        poster_path: item.Poster_URL || null,
                        drive_url: item.Drive_URL || null,
                        type: item.Type || null
                    });
                });
            }
            return card;
        };

        const renderWatchlistCards = (content, container) => {
             container.innerHTML = '';
            if (content.length === 0) {
                 const message = `<p class="text-center text-gray-400 col-span-full">Your watchlist is empty.</p>`;
                container.innerHTML = message;
                return;
            }
            content.forEach(item => {
                const card = createCard(item, false);
                container.appendChild(card);
            });
        };
        
        // --- Search Functionality ---
        const filterContent = () => {
            const query = searchInput.value.toLowerCase();
            let filteredMovies = [];
            let filteredSeries = [];
            let filteredAnime = [];

            if (query === '') {
                 renderCategories(allContent);
                 return;
            }

            const allFiltered = allContent.filter(item => item.Title.toLowerCase().includes(query));

            filteredMovies = allFiltered.filter(item => item.Type && item.Type.toLowerCase() === 'movie');
            filteredSeries = allFiltered.filter(item => item.Type && item.Type.toLowerCase() === 'series');
            filteredAnime = allFiltered.filter(item => item.Type && item.Type.toLowerCase() === 'anime');

            const filteredMovieContainer = document.createElement('div');
            filteredMovieContainer.id = 'filtered-movies';
            moviesContainer.innerHTML = '';
            if (filteredMovies.length > 0) {
                 const heading = document.createElement('h2');
                 heading.textContent = 'Filtered Movies';
                 heading.classList.add('text-2xl', 'font-bold', 'text-white', 'mb-6');
                 moviesContainer.appendChild(heading);
                 const cardsContainer = createGenreSection('Search Results', filteredMovies);
                 moviesContainer.appendChild(cardsContainer);
            } else {
                 moviesContainer.innerHTML = '<p class="text-center text-gray-400">No movies found.</p>';
            }

            const filteredSeriesContainer = document.createElement('div');
            filteredSeriesContainer.id = 'filtered-series';
            seriesContainer.innerHTML = '';
             if (filteredSeries.length > 0) {
                const heading = document.createElement('h2');
                heading.textContent = 'Filtered Series';
                heading.classList.add('text-2xl', 'font-bold', 'text-white', 'mb-6');
                seriesContainer.appendChild(heading);
                const cardsContainer = createGenreSection('Search Results', filteredSeries);
                seriesContainer.appendChild(cardsContainer);
             } else {
                seriesContainer.innerHTML = '<p class="text-center text-gray-400">No series found.</p>';
            }
            
            const filteredAnimeContainer = document.createElement('div');
            filteredAnimeContainer.id = 'filtered-anime';
            animeContainer.innerHTML = '';
            if (filteredAnime.length > 0) {
                 const heading = document.createElement('h2');
                 heading.textContent = 'Filtered Anime';
                 heading.classList.add('text-2xl', 'font-bold', 'text-white', 'mb-6');
                 animeContainer.appendChild(heading);
                 const cardsContainer = createGenreSection('Search Results', filteredAnime);
                 animeContainer.appendChild(cardsContainer);
            } else {
                 animeContainer.innerHTML = '<p class="text-center text-gray-400">No anime found.</p>';
            }
        };
        
        // --- Tab Switching Logic ---
        const showTab = (tabId) => {
            activeTab = tabId;
            moviesSection.classList.add('hidden');
            seriesSection.classList.add('hidden');
            animeSection.classList.add('hidden');
            
            tabMovies.classList.remove('bg-blue-600', 'text-white');
            tabSeries.classList.remove('bg-blue-600', 'text-white');
            tabAnime.classList.remove('bg-blue-600', 'text-white');
            tabMovies.classList.add('bg-gray-700', 'text-gray-300');
            tabSeries.classList.add('bg-gray-700', 'text-gray-300');
            tabAnime.classList.add('bg-gray-700', 'text-gray-300');
            
            if (tabId === 'movies') {
                moviesSection.classList.remove('hidden');
                tabMovies.classList.replace('bg-gray-700', 'bg-blue-600');
                tabMovies.classList.replace('text-gray-300', 'text-white');
            } else if (tabId === 'series') {
                seriesSection.classList.remove('hidden');
                tabSeries.classList.replace('bg-gray-700', 'bg-blue-600');
                tabSeries.classList.replace('text-gray-300', 'text-white');
            } else if (tabId === 'anime') {
                animeSection.classList.remove('hidden');
                tabAnime.classList.replace('bg-gray-700', 'bg-blue-600');
                tabAnime.classList.replace('text-gray-300', 'text-white');
            }
        };

        // --- Event Listeners and Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            fetchContentFromGoogleSheet();
            
            tabMovies.addEventListener('click', () => showTab('movies'));
            tabSeries.addEventListener('click', () => showTab('series'));
            tabAnime.addEventListener('click', () => showTab('anime'));
            
            searchInput.addEventListener('keyup', filterContent);

            document.addEventListener('mousemove', (e) => {
                customCursor.style.left = `${e.clientX}px`;
                customCursor.style.top = `${e.clientY}px`;
                if (!customCursor.classList.contains('active')) {
                    customCursor.classList.add('active');
                }
            });
            document.addEventListener('mouseleave', () => {
                customCursor.classList.remove('active');
            });
        });
    </script>
</body>
</html>

